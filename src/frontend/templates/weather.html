<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实时天气信息</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .weather-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            transform: scale(0.8);
            transform-origin: center;
        }

        .weather-header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            padding-bottom: 15px;
        }

        .weather-header h1 {
            color: #333;
            font-weight: 600;
            font-size: 28px;
        }

        .weather-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
        }

        /* 城市选择器样式 */
        .city-selector {
            margin-bottom: 25px;
            position: relative;
        }

        .city-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 16px;
            color: #333;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
        }

        .city-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .city-select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .city-loading {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            display: none;
        }

        .city-loading.show {
            display: block;
        }

        /* 定位提示样式 */
        .location-tip {
            text-align: center;
            font-size: 14px;
            color: #667eea;
            margin-bottom: 10px;
            padding: 8px;
            background-color: rgba(102, 126, 234, 0.05);
            border-radius: 6px;
            display: none;
        }

        .location-tip.show {
            display: block;
        }

        /* 加载状态样式 */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            font-size: 16px;
            color: #667eea;
            font-weight: 500;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* 错误状态样式 */
        .error {
            text-align: center;
            padding: 30px;
            color: #dc3545;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .error-text {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .error-desc {
            font-size: 14px;
            color: #6c757d;
        }

        /* 天气信息样式 */
        .weather-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .weather-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .card-value {
            font-size: 22px;
            color: #333;
            font-weight: 600;
        }

        .city-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .city-name {
            font-size: 24px;
            color: #333;
            font-weight: 600;
        }

        .report-time {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }

        .weather-desc {
            font-size: 20px;
            color: #667eea;
            font-weight: 500;
            text-align: center;
            margin: 10px 0 20px;
        }

        /* 响应式设计 */
        @media (max-width: 480px) {
            .weather-container {
                padding: 25px 20px;
                transform: scale(0.9);
            }

            .weather-header h1 {
                font-size: 22px;
            }

            .weather-card {
                padding: 15px;
            }

            .card-value {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="weather-container">
        <div class="weather-header">
            <h1>实时天气信息</h1>
        </div>

        <!-- 定位提示 -->
        <div id="locationTip" class="location-tip">正在通过地理位置获取您所在城市...</div>

        <!-- 城市选择器 -->
        <div class="city-selector">
            <select id="citySelect" class="city-select" disabled>
                <option value="">加载城市列表中...</option>
            </select>
            <div id="cityLoading" class="city-loading"></div>
        </div>

        <!-- 加载状态 -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在获取天气数据...</div>
        </div>

        <!-- 错误状态 -->
        <div id="error" class="error" style="display: none;">
            <div class="error-icon">❌</div>
            <div class="error-text" id="errorText">获取天气数据失败</div>
            <div class="error-desc" id="errorDesc">请稍后重试</div>
        </div>

        <!-- 天气数据展示区域 -->
        <div id="weatherContent" style="display: none;">
            <div class="city-info">
                <div class="city-name" id="cityName"></div>
                <div class="report-time" id="reportTime"></div>
            </div>
            
            <div class="weather-desc" id="weatherDesc"></div>
            
            <div class="weather-info">
                <div class="weather-card">
                    <div class="card-label">温度</div>
                    <div class="card-value" id="temperature">--</div>
                </div>
                <div class="weather-card">
                    <div class="card-label">湿度</div>
                    <div class="card-value" id="humidity">--</div>
                </div>
                <div class="weather-card">
                    <div class="card-label">风向</div>
                    <div class="card-value" id="windDirection">--</div>
                </div>
                <div class="weather-card">
                    <div class="card-label">风力</div>
                    <div class="card-value" id="windPower">--</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM元素获取
        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const weatherContentEl = document.getElementById('weatherContent');
        const errorTextEl = document.getElementById('errorText');
        const errorDescEl = document.getElementById('errorDesc');
        const citySelectEl = document.getElementById('citySelect');
        const cityLoadingEl = document.getElementById('cityLoading');
        const locationTipEl = document.getElementById('locationTip');
        
        // 天气数据展示元素
        const cityNameEl = document.getElementById('cityName');
        const reportTimeEl = document.getElementById('reportTime');
        const weatherDescEl = document.getElementById('weatherDesc');
        const temperatureEl = document.getElementById('temperature');
        const humidityEl = document.getElementById('humidity');
        const windDirectionEl = document.getElementById('windDirection');
        const windPowerEl = document.getElementById('windPower');

        // 配置项
        const API_CONFIG = {
            weatherUrl: '/api/weather/view',
            cityListUrl: '/api/weather/get_citys',
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // 存储城市列表和当前选中城市
        let cityList = [];
        let currentCityName = '';

        /**
         * 页面初始化入口
         */
        async function initPage() {
            try {
                // 1. 优先加载城市列表
                await loadCityList();
                
                // 2. 获取当前地理位置（自动定位）
                await getCurrentLocation();
                
                // 3. 加载默认天气数据（列表第一个城市）
                if (currentCityName) {
                    await loadWeatherData(currentCityName);
                } else if (cityList.length > 0) {
                    currentCityName = cityList[0];
                    await loadWeatherData(currentCityName);
                }

            } catch (error) {
                console.error('页面初始化失败:', error);
                showError('初始化失败', error.message || '请手动选择城市查询天气');
            }
        }

        /**
         * 加载后端城市列表（适配纯字符串列表）
         */
        async function loadCityList() {
            try {
                cityLoadingEl.classList.add('show');
                
                const response = await fetch(API_CONFIG.cityListUrl, {
                    method: API_CONFIG.method,
                    headers: API_CONFIG.headers
                });

                if (!response.ok) {
                    throw new Error(`城市列表请求失败 [${response.status}]`);
                }

                cityList = await response.json();
                console.log('后端返回的城市列表:', cityList);

                // 清空下拉框并填充默认选项
                citySelectEl.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = '请选择城市';
                citySelectEl.appendChild(defaultOption);

                // 动态构建下拉选项（纯字符串列表）
                cityList.forEach(cityName => {
                    const option = document.createElement('option');
                    option.value = cityName; // 城市名作为value
                    option.textContent = cityName; // 城市名作为显示文本
                    citySelectEl.appendChild(option);
                });

                // 启用城市选择器
                citySelectEl.disabled = false;

                // 绑定城市切换事件（核心：传递动态城市名）
                citySelectEl.addEventListener('change', function() {
                    const selectedCity = this.value;
                    if (selectedCity && selectedCity !== '') {
                        currentCityName = selectedCity;
                        console.log('当前选中城市:', selectedCity);
                        loadWeatherData(selectedCity); // 触发天气动态刷新
                    }
                });

            } catch (error) {
                console.error('加载城市列表失败:', error);
                citySelectEl.innerHTML = '<option value="">加载城市列表失败</option>';
                throw error;
            } finally {
                cityLoadingEl.classList.remove('show');
            }
        }

        /**
         * 获取当前地理位置（浏览器定位）
         */
        async function getCurrentLocation() {
            // 浏览器不支持定位时直接返回
            if (!navigator.geolocation) {
                console.log('当前浏览器不支持地理位置定位');
                return;
            }

            try {
                locationTipEl.classList.add('show');

                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve, 
                        reject, 
                        { timeout: 10000, maximumAge: 300000 } // 超时10秒，缓存5分钟
                    );
                });

                const { latitude, longitude } = position.coords;
                console.log('当前定位经纬度:', latitude, longitude);

                // 可扩展：经纬度转城市名称（需后端接口支持）
                if (cityList.length > 0) {
                    // 暂不处理，可手动匹配
                }

            } catch (error) {
                console.log('定位失败:', error.message);
            } finally {
                locationTipEl.classList.remove('show');
            }
        }

        /**
         * 加载指定城市的天气数据（核心：动态刷新）
         * @param {string} cityName 选中的城市名称
         */
        async function loadWeatherData(cityName) {
            try {
                // 显示加载状态
                loadingEl.style.display = 'flex';
                errorEl.style.display = 'none';
                weatherContentEl.style.display = 'none';

                // 1. 中文编码 + 时间戳：解决中文乱码和缓存问题
                const encodedCityName = encodeURIComponent(cityName);
                const timestamp = Date.now(); // 时间戳确保每次请求唯一，规避缓存
                // 2. 参数名使用 city（与后端标准参数匹配，同时后端兼容 adcode）
                const weatherUrl = `${API_CONFIG.weatherUrl}${API_CONFIG.weatherUrl.includes('?') ? '&' : '?'}city=${encodedCityName}&_t=${timestamp}`;

                // 3. 禁用缓存，强制发起新请求
                const response = await fetch(weatherUrl, {
                    method: API_CONFIG.method,
                    headers: API_CONFIG.headers,
                    cache: 'no-cache' // 禁用浏览器缓存
                });

                if (!response.ok) {
                    throw new Error(`天气请求失败 [${response.status}] ${response.statusText}`);
                }

                // 解析动态天气数据
                const jsonData = await response.json();
                console.log(`【${cityName}】动态天气数据:`, jsonData);

                // 验证数据结构
                validateWeatherData(jsonData);

                // 渲染天气数据到页面
                renderWeatherData(jsonData.lives[0]);

                // 同步下拉框选中状态
                const weatherData = jsonData.lives[0];
                if (weatherData && weatherData.city) {
                    citySelectEl.value = weatherData.city;
                }

                // 显示天气内容，隐藏加载状态
                loadingEl.style.display = 'none';
                weatherContentEl.style.display = 'block';

            } catch (error) {
                console.error(`加载 ${cityName} 天气失败:`, error);
                showError('获取天气失败', error.message || '请选择其他城市重试');
            }
        }

        /**
         * 验证天气数据结构有效性
         */
        function validateWeatherData(data) {
            const requiredFields = ['status', 'lives'];
            const missingFields = requiredFields.filter(field => !data.hasOwnProperty(field));
            
            if (missingFields.length > 0) {
                throw new Error('天气数据结构不完整', { cause: `缺失字段: ${missingFields.join(', ')}` });
            }

            if (data.status !== '1') {
                throw new Error('后端返回错误状态', { cause: `info: ${data.info || '未知'}, infocode: ${data.infocode || '无'}` });
            }

            if (!Array.isArray(data.lives) || data.lives.length === 0) {
                throw new Error('天气数据为空');
            }

            const liveData = data.lives[0];
            const liveRequiredFields = ['province', 'city', 'weather', 'temperature', 'humidity', 'winddirection', 'windpower', 'reporttime'];
            const liveMissingFields = liveRequiredFields.filter(field => !liveData.hasOwnProperty(field));
            
            if (liveMissingFields.length > 0) {
                throw new Error('天气详情不完整', { cause: `缺失字段: ${liveMissingFields.join(', ')}` });
            }
        }

        /**
         * 渲染天气数据到页面
         */
        function renderWeatherData(weatherData) {
            cityNameEl.textContent = `${weatherData.province} ${weatherData.city}`;
            reportTimeEl.textContent = `数据更新时间: ${weatherData.reporttime}`;
            weatherDescEl.textContent = weatherData.weather;
            temperatureEl.textContent = `${weatherData.temperature}°C`;
            humidityEl.textContent = `${weatherData.humidity}%`;
            windDirectionEl.textContent = weatherData.winddirection;
            windPowerEl.textContent = `${weatherData.windpower}级`;
        }

        /**
         * 统一错误展示
         */
        function showError(title, desc) {
            loadingEl.style.display = 'none';
            weatherContentEl.style.display = 'none';
            errorEl.style.display = 'block';
            errorTextEl.textContent = title;
            errorDescEl.textContent = desc;
        }

        // 页面加载完成后自动初始化
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品列表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* 保持之前的样式不变，添加删除相关样式 */
        
        .delete-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .modal-content h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .modal-content p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .delete-confirm {
            background: #e74c3c;
            color: white;
        }
        
        .delete-confirm:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .delete-cancel {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #ddd;
        }
        
        .delete-cancel:hover {
            background: #e9ecef;
        }
        
        .product-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .view-btn, .edit-btn, .delete-btn {
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .view-btn {
            background: #667eea;
            color: white;
        }
        
        .view-btn:hover {
            background: #5a67d8;
        }
        
        .edit-btn {
            background: #3498db;
            color: white;
        }
        
        .edit-btn:hover {
            background: #2980b9;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
            animation: slideDown 0.3s ease;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #e74c3c;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* 批量操作区域 */
        .batch-actions {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .select-all {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .batch-buttons {
            display: flex;
            gap: 10px;
        }
        
        .batch-delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .batch-delete-btn:hover {
            background: #c0392b;
        }
        
        .product-select {
            margin-right: 10px;
        }
        
        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .empty-state i {
            font-size: 60px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #888;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>商品列表</h1>
            <div class="action-buttons">
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加商品
                </a>
                <a href="{{ url_for('get_products_api') }}" class="btn btn-secondary" target="_blank">
                    <i class="fas fa-code"></i> API数据
                </a>
            </div>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="{{ 'success-message' if category == 'success' else 'error-message' }}">
                        <i class="fas {{ 'fa-check-circle' if category == 'success' else 'fa-exclamation-circle' }}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <!-- 批量操作区域 -->
        {% if products %}
        <div class="batch-actions">
            <div class="select-all">
                <input type="checkbox" id="select-all">
                <label for="select-all">全选</label>
            </div>
            <div class="batch-buttons">
                <button type="button" class="batch-delete-btn" onclick="batchDelete()">
                    <i class="fas fa-trash"></i> 批量删除
                </button>
            </div>
            <div style="margin-left: auto; color: #666;">
                已选择 <span id="selected-count">0</span> 个商品
            </div>
        </div>
        {% endif %}
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number">{{ products|length }}</div>
                <div class="stat-label">商品总数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {{ products|selectattr('stock', 'gt', 0)|list|length }}
                </div>
                <div class="stat-label">有库存商品</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">
                    {% set total_value = namespace(value=0) %}
                    {% for p in products %}
                        {% set total_value.value = total_value.value + (p.price * p.stock) %}
                    {% endfor %}
                    ¥{{ "%.2f"|format(total_value.value) }}
                </div>
                <div class="stat-label">库存总价值</div>
            </div>
        </div>
        
        {% if products %}
            <div class="products-grid">
                {% for product in products|reverse %}
                <div class="product-card" data-product-id="{{ product.id }}">
                    <input type="checkbox" class="product-select" data-product-id="{{ product.id }}">
                    <div class="product-image">
                        {% if product.image_url %}
                            <img src="{{ url_for('static', filename=product.image_url) }}" alt="{{ product.product_name }}">
                        {% else %}
                            <div style="text-align: center; color: #888;">
                                <i class="fas fa-image" style="font-size: 50px;"></i>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="product-info">
                        <h3 class="product-name">{{ product.product_name }}</h3>
                        
                        <div class="product-price">¥{{ product.price }}</div>
                        
                        <div class="product-meta">
                            <span class="product-type">{{ product.product_type }}</span>
                            <span class="product-stock">库存: {{ product.stock }}</span>
                        </div>
                        
                        <div class="product-actions">
                            <small style="color: #888;">ID: #{{ product.id }}</small>
                            <div class="action-buttons">
                                <a href="{{ url_for('product_detail', product_id=product.id) }}" class="view-btn">
                                    <i class="fas fa-eye"></i> 查看
                                </a>
                                <a href="{{ url_for('edit_product', product_id=product.id) }}" class="edit-btn">
                                    <i class="fas fa-edit"></i> 编辑
                                </a>
                                <button type="button" class="delete-btn" onclick="confirmDelete({{ product.id }}, '{{ product.product_name }}')">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>暂无商品信息</h3>
                <p>还没有添加任何商品，快去添加第一个商品吧！</p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> 添加商品
                </a>
            </div>
        {% endif %}
    </div>
    
    <!-- 删除确认模态框 -->
    <div id="deleteModal" class="delete-modal">
        <div class="modal-content">
            <h3>确认删除</h3>
            <p id="delete-message">确定要删除这个商品吗？此操作不可撤销。</p>
            <form id="delete-form" method="POST" style="display: none;">
                <!-- 这个表单会被JavaScript动态填充 -->
            </form>
            <div class="modal-buttons">
                <button type="button" class="modal-btn delete-confirm" onclick="deleteProduct()">确认删除</button>
                <button type="button" class="modal-btn delete-cancel" onclick="closeModal()">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 批量删除确认模态框 -->
    <div id="batchDeleteModal" class="delete-modal">
        <div class="modal-content">
            <h3>批量删除确认</h3>
            <p id="batch-delete-message">确定要删除选中的 <span id="delete-count">0</span> 个商品吗？此操作不可撤销。</p>
            <div class="modal-buttons">
                <button type="button" class="modal-btn delete-confirm" onclick="confirmBatchDelete()">确认删除</button>
                <button type="button" class="modal-btn delete-cancel" onclick="closeBatchModal()">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 删除模态框相关变量
        let currentProductId = null;
        let currentProductName = '';
        
        // 显示删除确认模态框
        function confirmDelete(productId, productName) {
            currentProductId = productId;
            currentProductName = productName;
            
            const modal = document.getElementById('deleteModal');
            const message = document.getElementById('delete-message');
            
            message.textContent = `确定要删除商品 "${productName}" 吗？此操作不可撤销。`;
            modal.style.display = 'flex';
        }
        
        // 关闭删除模态框
        function closeModal() {
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'none';
            currentProductId = null;
            currentProductName = '';
        }
        
        // 执行删除操作
        function deleteProduct() {
            if (currentProductId) {
                // 创建表单并提交
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/delete_product/${currentProductId}`;
                
                // 添加CSRF令牌（如果有的话）
                const csrfToken = document.createElement('input');
                csrfToken.type = 'hidden';
                csrfToken.name = 'csrf_token';
                csrfToken.value = '{{ csrf_token() if csrf_token else "" }}';
                form.appendChild(csrfToken);
                
                document.body.appendChild(form);
                form.submit();
            }
        }
        
        // 批量选择功能
        document.getElementById('select-all').addEventListener('change', function(e) {
            const checkboxes = document.querySelectorAll('.product-select');
            checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateSelectedCount();
        });
        
        // 更新已选择商品数量
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.product-select:checked').length;
            document.getElementById('selected-count').textContent = selectedCount;
        }
        
        // 监听每个商品的选择框
        document.querySelectorAll('.product-select').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        // 显示批量删除确认模态框
        function batchDelete() {
            const selectedCount = document.querySelectorAll('.product-select:checked').length;
            
            if (selectedCount === 0) {
                alert('请先选择要删除的商品');
                return;
            }
            
            document.getElementById('delete-count').textContent = selectedCount;
            document.getElementById('batchDeleteModal').style.display = 'flex';
        }
        
        // 关闭批量删除模态框
        function closeBatchModal() {
            document.getElementById('batchDeleteModal').style.display = 'none';
        }
        
        // 执行批量删除
        function confirmBatchDelete() {
            const selectedCheckboxes = document.querySelectorAll('.product-select:checked');
            const productIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.productId);
            
            // 使用AJAX批量删除
            if (productIds.length > 0) {
                // 可以改为使用AJAX批量删除
                // 这里为了简单，我们重定向到一个批量删除的URL
                window.location.href = `/batch_delete?ids=${productIds.join(',')}`;
            }
            
            closeBatchModal();
        }
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const deleteModal = document.getElementById('deleteModal');
            const batchModal = document.getElementById('batchDeleteModal');
            
            if (event.target === deleteModal) {
                closeModal();
            }
            
            if (event.target === batchModal) {
                closeBatchModal();
            }
        });
        
        // 按ESC键关闭模态框
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
                closeBatchModal();
            }
        });
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectedCount();
        });
    </script>
</body>
</html>